name: Production Health Check

on:
  schedule:
    # Run every 15 minutes
    - cron: '*/15 * * * *'
  workflow_dispatch:

env:
  PRODUCTION_BACKEND_URL: https://yoga-app-production.up.railway.app
  PRODUCTION_FRONTEND_URL: https://yoga-app-production.up.railway.app

jobs:
  health-check:
    name: Monitor Production Health
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check backend health
        id: backend-health
        run: |
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.PRODUCTION_BACKEND_URL }}/health)

          if [ "$RESPONSE" == "200" ]; then
            echo "status=healthy" >> $GITHUB_OUTPUT
            echo "âœ… Backend is healthy (HTTP $RESPONSE)"
          else
            echo "status=unhealthy" >> $GITHUB_OUTPUT
            echo "âŒ Backend is unhealthy (HTTP $RESPONSE)"
            exit 1
          fi

      - name: Check backend API
        run: |
          curl -f ${{ env.PRODUCTION_BACKEND_URL }}/api/v1/poses || exit 1
          echo "âœ… Backend API responding"

      - name: Check frontend
        id: frontend-health
        run: |
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.PRODUCTION_FRONTEND_URL }})

          if [ "$RESPONSE" == "200" ]; then
            echo "status=healthy" >> $GITHUB_OUTPUT
            echo "âœ… Frontend is healthy (HTTP $RESPONSE)"
          else
            echo "status=unhealthy" >> $GITHUB_OUTPUT
            echo "âŒ Frontend is unhealthy (HTTP $RESPONSE)"
            exit 1
          fi

      - name: Check response time
        run: |
          RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}' ${{ env.PRODUCTION_BACKEND_URL }}/health)
          echo "Backend response time: ${RESPONSE_TIME}s"

          # Warn if response time is too high
          if (( $(echo "$RESPONSE_TIME > 2.0" | bc -l) )); then
            echo "âš ï¸ High response time detected: ${RESPONSE_TIME}s"
          fi

      - name: Check database connectivity
        run: |
          # Health endpoint includes database check
          HEALTH_RESPONSE=$(curl -s ${{ env.PRODUCTION_BACKEND_URL }}/health)
          echo "$HEALTH_RESPONSE"

          if echo "$HEALTH_RESPONSE" | grep -q "healthy"; then
            echo "âœ… Database connectivity verified"
          else
            echo "âŒ Database connectivity issue"
            exit 1
          fi

      - name: Create incident if unhealthy
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            // Check if there's already an open incident
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'incident,production'
            });

            if (issues.data.length === 0) {
              // Create new incident
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸš¨ Production Health Check Failed',
                body: `## Production Health Check Failed\n\n` +
                      `**Time:** ${new Date().toISOString()}\n` +
                      `**Backend Status:** ${{ steps.backend-health.outputs.status }}\n` +
                      `**Frontend Status:** ${{ steps.frontend-health.outputs.status }}\n\n` +
                      `### Actions Required\n` +
                      `- [ ] Check Railway logs\n` +
                      `- [ ] Verify database connectivity\n` +
                      `- [ ] Check environment variables\n` +
                      `- [ ] Consider rollback if issue persists\n\n` +
                      `### Useful Links\n` +
                      `- [Railway Dashboard](https://railway.app)\n` +
                      `- [Backend URL](${{ env.PRODUCTION_BACKEND_URL }})\n` +
                      `- [Workflow Run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
                labels: ['incident', 'production', 'urgent']
              });
            }

  performance-check:
    name: Performance Monitoring
    runs-on: ubuntu-latest
    steps:
      - name: Install artillery
        run: npm install -g artillery

      - name: Run load test
        run: |
          cat > loadtest.yml <<EOF
          config:
            target: '${{ env.PRODUCTION_BACKEND_URL }}'
            phases:
              - duration: 60
                arrivalRate: 5
                name: Warm up
          scenarios:
            - name: Health check
              flow:
                - get:
                    url: '/health'
            - name: List poses
              flow:
                - get:
                    url: '/api/v1/poses'
          EOF

          artillery run loadtest.yml || true

      - name: Check SSL certificate
        run: |
          EXPIRY=$(echo | openssl s_client -servername yoga-app-production.up.railway.app \
                   -connect yoga-app-production.up.railway.app:443 2>/dev/null | \
                   openssl x509 -noout -enddate | cut -d= -f2)

          echo "SSL Certificate expires: $EXPIRY"

          # Calculate days until expiry
          EXPIRY_EPOCH=$(date -d "$EXPIRY" +%s)
          NOW_EPOCH=$(date +%s)
          DAYS_LEFT=$(( ($EXPIRY_EPOCH - $NOW_EPOCH) / 86400 ))

          echo "Days until expiry: $DAYS_LEFT"

          if [ $DAYS_LEFT -lt 30 ]; then
            echo "âš ï¸ SSL certificate expires in $DAYS_LEFT days"
          fi

  update-status:
    name: Update Status Page
    runs-on: ubuntu-latest
    needs: [health-check, performance-check]
    if: always()
    steps:
      - name: Update status
        run: |
          STATUS="operational"
          if [ "${{ needs.health-check.result }}" != "success" ]; then
            STATUS="major_outage"
          elif [ "${{ needs.performance-check.result }}" != "success" ]; then
            STATUS="degraded_performance"
          fi

          echo "Current status: $STATUS"
          echo "status=$STATUS" >> $GITHUB_OUTPUT

          # Here you would update your status page
          # For example, using statuspage.io API or similar
